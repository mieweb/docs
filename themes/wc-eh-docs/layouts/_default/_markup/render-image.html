{{- /* render_image.html */ -}}

{{- $dest := .Destination | default "" -}}
{{- $alt  := .PlainText | default "" -}}
{{- $title := .Title -}}

{{- /* If destination is absolute URL, use it as-is */ -}}
{{- if strings.Contains $dest "://" -}}
  {{- $src := $dest -}}

{{- else -}}
  {{- /* Try to find as page resource (page bundle). Match by base filename. */ -}}
  {{- $basename := path.Base $dest -}}
  {{- $img := .Page.Resources.GetMatch (printf "*%s" $basename) -}}

  {{- if $img -}}
    {{- $src := $img.RelPermalink -}}
  {{- else -}}
    {{- /*
         Not a page resource. Consider three cases:
         - $dest starts with '/' -> treat as site-rooted path (use relURL/absURL as desired)
         - $dest is relative -> join with page file dir to create relative path
       */ -}}
    {{- if strings.HasPrefix $dest "/" -}}
      {{- $src := $dest | relURL -}}
    {{- else -}}
      {{- /* join page dir and destination then relURL it */ -}}
      {{- $joined := path.Join .Page.File.Dir $dest -}}
      {{- $src := $joined | relURL -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Use the computed $src value above (we need one canonical variable scope) */ -}}
{{- /* The previous if/else blocks declared $src inside branches; repeat logic cleanly below for output. */ -}}
{{- /* Simpler: compute $src in local var first, then choose tag. */ -}}
{{- $src := "" -}}
{{- if strings.Contains $dest "://" -}}
  {{- $src = $dest -}}
{{- else if $img := .Page.Resources.GetMatch (printf "*%s" (path.Base $dest)) -}}
  {{- $src = $img.RelPermalink -}}
{{- else if strings.HasPrefix $dest "/" -}}
  {{- $src = $dest | relURL -}}
{{- else -}}
  {{- $src = (path.Join .Page.File.Dir $dest) | relURL -}}
{{- end -}}

{{- if strings.HasSuffix $dest ".svg" }}
<object type="image/svg+xml" data="{{ $src }}">
  <img src="{{ $src }}" alt="{{ $alt }}" {{ with $title }} title="{{ . }}" {{ end }} />
</object>
{{- else }}
<img src="{{ $src }}" alt="{{ $alt }}" {{ with $title }} title="{{ . }}" {{ end }} />
{{- end -}}
